<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Withdraw | PremierPredict</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">
  <!-- Header -->
  <header class="bg-blue-600 text-white py-4 shadow">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">PremierPredict</h1>
      <span id="username" class="text-sm font-medium"></span>
    </div>
  </header>

  <!-- Balance Section -->
  <section class="container mx-auto mt-6 px-4">
    <div class="bg-white rounded-xl shadow p-4 flex items-center justify-between">
      <div>
        <h2 class="text-gray-500 text-sm">Wallet Balance</h2>
        <p id="balance" class="text-2xl font-bold text-gray-900 mt-1">₦0.00</p>
      </div>
      <div>
        <button onclick="loadWallet()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
          Refresh
        </button>
      </div>
    </div>
  </section>

  <!-- Withdrawal Form -->
  <section class="container mx-auto mt-6 px-4">
    <div class="bg-white rounded-xl shadow p-5">
      <h2 class="text-lg font-semibold mb-4">Withdraw Funds</h2>
      <form id="withdrawForm" class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-600">Account Name</label>
          <input type="text" id="account_name" required class="w-full border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-600">Bank Name</label>
          <input type="text" id="bank_name" required class="w-full border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-600">Account Number</label>
          <input type="text" id="account_number" maxlength="10" required class="w-full border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-600">Amount (₦)</label>
          <input type="number" id="amount" min="100" step="100" required class="w-full border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
        </div>

        <button type="submit" class="bg-blue-600 text-white w-full py-2 rounded-lg font-semibold hover:bg-blue-700">
          Withdraw Now
        </button>
      </form>
    </div>
  </section>

  <!-- Withdrawal History -->
  <section class="container mx-auto mt-8 px-4 pb-8">
    <h2 class="text-lg font-semibold mb-3">Withdrawal History</h2>
    <div class="bg-white rounded-xl shadow overflow-x-auto">
      <table class="min-w-full text-sm text-left border">
        <thead class="bg-gray-50 border-b">
          <tr>
            <th class="px-4 py-3">Date</th>
            <th class="px-4 py-3">Amount</th>
            <th class="px-4 py-3">Status</th>
          </tr>
        </thead>
        <tbody id="historyBody" class="divide-y"></tbody>
      </table>
    </div>
  </section>

  <!-- Spinner -->
  <div id="spinner" class="fixed inset-0 bg-white bg-opacity-60 flex items-center justify-center hidden z-50">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600"></div>
  </div>

  <script>
    const API = "/api";
    const spinner = document.getElementById("spinner");

    const showSpinner = () => spinner.classList.remove("hidden");
    const hideSpinner = () => spinner.classList.add("hidden");

    function formatMoney(kobo) {
      return "₦" + (kobo / 100).toLocaleString("en-NG", { minimumFractionDigits: 2 });
    }

    async function loadWallet() {
      showSpinner();
      try {
        const walletRes = await fetch(API + "/wallet", { headers: authHeader() });
        const walletData = await walletRes.json();
        document.getElementById("balance").textContent = formatMoney(walletData.balance_kobo);
      } catch (err) {
        console.error(err);
        alert("Error loading wallet balance");
      }
      hideSpinner();
    }

    async function loadUser() {
      try {
        const res = await fetch(API + "/auth/me", { headers: authHeader() });
        const data = await res.json();
        document.getElementById("username").textContent = data.username || "User";
      } catch (err) {
        console.error("Error loading user:", err);
      }
    }

    async function loadHistory() {
      showSpinner();
      try {
        const res = await fetch(API + "/withdrawals", { headers: authHeader() });
        const data = await res.json();
        const body = document.getElementById("historyBody");

        if (!Array.isArray(data) || data.length === 0) {
          body.innerHTML = `<tr><td colspan="3" class="text-center py-5 text-gray-500">No withdrawals yet</td></tr>`;
        } else {
          body.innerHTML = data.map(w => `
            <tr>
              <td class="px-4 py-2">${new Date(w.created_at).toLocaleString()}</td>
              <td class="px-4 py-2 font-semibold">${formatMoney(w.amount_kobo)}</td>
              <td class="px-4 py-2">
                <span class="px-2 py-1 rounded text-xs ${
                  w.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                  w.status === 'paid' ? 'bg-green-100 text-green-700' :
                  'bg-red-100 text-red-700'
                }">${w.status}</span>
              </td>
            </tr>
          `).join("");
        }
      } catch (err) {
        console.error("Error loading history:", err);
        alert("Could not load withdrawal history");
      }
      hideSpinner();
    }

    async function createWithdrawal(e) {
      e.preventDefault();
      showSpinner();

      const amount = parseFloat(document.getElementById("amount").value);
      const bank_name = document.getElementById("bank_name").value;
      const account_number = document.getElementById("account_number").value;
      const account_name = document.getElementById("account_name").value;

      try {
        const res = await fetch(API + "/withdrawals", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...authHeader()
          },
          body: JSON.stringify({ amount, bank_name, account_number, account_name })
        });
        const data = await res.json();

        if (res.ok) {
          alert("Withdrawal request submitted successfully!");
          document.getElementById("withdrawForm").reset();
          await loadWallet();
          await loadHistory();
        } else {
          alert(data.error || "Failed to submit withdrawal");
        }
      } catch (err) {
        console.error(err);
        alert("Server error");
      }
      hideSpinner();
    }

    function authHeader() {
      const token = localStorage.getItem("token");
      return token ? { "Authorization": "Bearer " + token } : {};
    }

    document.getElementById("withdrawForm").addEventListener("submit", createWithdrawal);

    (async () => {
      await loadUser();
      await loadWallet();
      await loadHistory();
    })();
  </script>
</body>
  </html>
