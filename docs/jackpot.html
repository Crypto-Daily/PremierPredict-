<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Jackpot — PremierPredict</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #f5f7fb; margin: 0; }
    header { background: #007bff; color: #fff; padding: 1rem; display:flex; justify-content:space-between; }
    .container { max-width: 800px; margin: 1.5rem auto; padding: 1rem; background: #fff; border-radius: 10px; }
    .match { border:1px solid #ddd; padding:1rem; margin:1rem 0; border-radius: 6px; }
    .options label { margin-right: 10px; }
    button { background: #007bff; color:#fff; padding:0.6rem 1.2rem; border:none; border-radius:6px; cursor:pointer; }
    button:hover { background:#005fcc; }
  </style>
</head>
<body>
  <header>
    <h1>PremierPredict Jackpot</h1>
    <a href="#" id="logout" style="color:#fff;">Logout</a>
  </header>

  <main class="container">
    <section id="round">
      <h2 id="roundName">Loading...</h2>
      <div id="matches"></div>
      <button id="submitBtn">Place Ticket (₦100)</button>
    </section>

    <hr>

    <section>
      <h2>My Tickets</h2>
      <div id="tickets"></div>
    </section>
  </main>

<script>
const API = "/api/jackpot";
const getToken = () => localStorage.getItem("token");

document.getElementById("logout").onclick = e => {
  e.preventDefault();
  localStorage.removeItem("token");
  location.href = "index.html";
};

// fetch helper
async function fetchJSON(url, opts){
  const headers = opts?.headers || {};
  if(getToken()) headers.Authorization = "Bearer " + getToken();
  const res = await fetch(url, { ...opts, headers });
  return { ok: res.ok, body: await res.json().catch(()=>({})) };
}

// load active round
async function loadRound(){
  const { ok, body } = await fetchJSON(API);
  const matchesDiv = document.getElementById("matches");
  if(!ok || !body.matches){
    document.getElementById("roundName").textContent = "No active round";
    matchesDiv.innerHTML = "";
    return;
  }
  document.getElementById("roundName").textContent = body.name + " (Round " + body.id + ")";
  matchesDiv.innerHTML = body.matches.map(m => `
    <div class="match" data-match-id="${m.match_id}">
      <b>${m.home_team}</b> vs <b>${m.away_team}</b>
      <div>
        <label><input type="radio" name="m_${m.match_id}" value="H"> Home</label>
        <label><input type="radio" name="m_${m.match_id}" value="D"> Draw</label>
        <label><input type="radio" name="m_${m.match_id}" value="A"> Away</label>
      </div>
    </div>
  `).join("");
}

// submit bet
document.getElementById("submitBtn").onclick = async () => {
  const selections = [];
  document.querySelectorAll(".match").forEach(div => {
    const matchId = Number(div.dataset.matchId);
    const choice = div.querySelector("input:checked");
    if(choice) selections.push({ match_id: matchId, selection: choice.value });
  });
  if(selections.length !== 10){
    alert("Please select all 10 predictions.");
    return;
  }
  const { ok, body } = await fetchJSON(API+"/bet", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ selections })
  });
  if(ok){
    alert("✅ Ticket placed!");
    loadTickets();
  } else {
    alert("❌ " + (body.error || "Error"));
  }
};

// load tickets
async function loadTickets(){
  const { ok, body } = await fetchJSON(API+"/tickets");
  const target = document.getElementById("tickets");
  if(!ok || !body.tickets) return target.innerHTML = "<p>No tickets</p>";
  target.innerHTML = body.tickets.map(t => `
    <div class="ticket">
      <b>Ticket #${t.id}</b> — Round ${t.round_id} (${new Date(t.created_at).toLocaleString()})
      <ul>
        ${t.selections.map(s => `<li>Match ${s.match_id}: ${s.selection} → ${s.result || "pending"}</li>`).join("")}
      </ul>
    </div>
  `).join("");
}

// init
(async ()=>{
  if(!getToken()){
    alert("Login first.");
    location.href = "index.html";
    return;
  }
  await loadRound();
  await loadTickets();
})();
</script>
</body>
</html>
