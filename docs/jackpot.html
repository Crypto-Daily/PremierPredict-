<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Jackpot — PremierPredict</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary: #007bff;
      --bg: #f5f7fb;
      --card: #fff;
      --text: #222;
      --muted: #666;
      --radius: 10px;
      --shadow: 0 6px 16px rgba(0,0,0,.08);
    }
    body { font-family: "Segoe UI", Arial, sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); }
    header { background: var(--primary); color: #fff; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; font-size: 1.4rem; }
    nav a { color: #fff; margin-left: 1rem; text-decoration: none; font-weight: 500; }
    nav a:hover { text-decoration: underline; }
    .container { max-width: 960px; margin: 2rem auto; padding: 1.5rem; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); }
    h2 { margin-top: 0; }
    .match, .ticket { border: 1px solid #eee; padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem; background: #fafafa; }
    .muted { color: var(--muted); font-size: .85rem; }
    .options label { margin-right: 12px; cursor: pointer; }
    button { background: var(--primary); color: #fff; border: none; padding: .7rem 1.2rem; border-radius: var(--radius); font-size: 1rem; cursor: pointer; transition: 0.2s ease; }
    button:hover { background: #0063d1; }
    ul { padding-left: 1.2rem; margin: .5rem 0 0; }
    ul li { margin-bottom: .4rem; }
    hr { margin: 2rem 0; border: none; border-top: 1px solid #eee; }
    @media(max-width:600px){ header, .container { padding: 1rem; } nav a { margin-left: .5rem; font-size: .9rem; } }
  </style>
</head>
<body>
  <header>
    <h1>PremierPredict Jackpot</h1>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="wallet.html">Wallet</a>
      <a href="#" id="logout">Logout</a>
    </nav>
  </header>

  <main class="container">
    <section id="roundSection">
      <h2 id="roundName">Loading round…</h2>
      <p id="roundMeta" class="muted"></p>
      <div id="matches"></div>
      <p class="muted">Bet amount fixed at ₦100 per ticket.</p>
      <button id="submitBtn">Place Ticket (₦100)</button>
    </section>

    <hr>

    <section>
      <h2>My Tickets</h2>
      <div id="ticketsArea">Loading tickets…</div>
    </section>
  </main>

<script>
const API = "/api/jackpot";
const getToken = ()=> localStorage.getItem("token");

// logout
document.getElementById("logout").addEventListener("click", e=>{
  e.preventDefault();
  localStorage.removeItem("token");
  location.href = "index.html";
});

// helper for API calls
async function fetchJSON(url, opts){
  const headers = opts?.headers || {};
  if(getToken()) headers.Authorization = `Bearer ${getToken()}`;
  const res = await fetch(url, { ...opts, headers });
  const json = await res.json().catch(()=>({}));
  return { ok: res.ok, status: res.status, body: json };
}

// escape HTML
function escapeHtml(s){ 
  return (s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c])); 
}

// load active round
async function loadRound(){
  const r = await fetchJSON(API, { method:"GET" });
  const roundName = document.getElementById("roundName");
  const roundMeta = document.getElementById("roundMeta");
  const matchesDiv = document.getElementById("matches");

  if(!r.ok || !r.body.matches){
    roundName.textContent = r.body.message || "No active round";
    matchesDiv.innerHTML = "<p class='muted'>No matches to display</p>";
    return;
  }

  const round = r.body;
  roundName.textContent = round.name;
  roundMeta.textContent = `Prize pool: ₦${(Number(round.prize_pool_kobo)/100).toLocaleString()} — Status: ${round.status}`;

  matchesDiv.innerHTML = round.matches.map(m=>`
    <div class="match">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;">
        <div>
          <strong>${escapeHtml(m.home_team)}</strong> vs <strong>${escapeHtml(m.away_team)}</strong>
          <div class="muted">${new Date(m.match_time).toLocaleString()}</div>
        </div>
        <div class="options">
          <label><input type="radio" name="m_${m.match_id}" value="home_win"> Home</label>
          <label><input type="radio" name="m_${m.match_id}" value="draw"> Draw</label>
          <label><input type="radio" name="m_${m.match_id}" value="away_win"> Away</label>
        </div>
      </div>
    </div>
  `).join("");
}

// place ticket
document.getElementById("submitBtn").addEventListener("click", async ()=>{
  const matches = document.querySelectorAll(".match");
  const selections = [];

  for(const div of matches){
    const radios = div.querySelectorAll("input[type=radio]");
    let chosen = null;
    for(const r of radios) if(r.checked) chosen = r.value;
    if(!chosen){
      alert("⚠️ Please pick a prediction for every match.");
      return;
    }
    const matchId = Number(radios[0].name.split("_")[1]);
    selections.push({ match_id: matchId, selection: chosen });
  }

  if(selections.length !== 10){
    alert("⚠️ Exactly 10 predictions are required.");
    return;
  }

  const { ok, body } = await fetchJSON(`${API}/bet`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ selections })
  });

  if(!ok){
    alert("❌ Error: " + (body.error || JSON.stringify(body)));
    return;
  }
  alert("✅ Ticket placed! Ref: " + (body.reference || body.ticketId));
  loadTickets();
});

// load user tickets
async function loadTickets(){
  const target = document.getElementById("ticketsArea");
  const { ok, body } = await fetchJSON(`${API}/tickets`, { method: "GET" });

  if(!ok){
    target.innerHTML = "<p class='muted'>Could not load tickets. Try refreshing.</p>";
    return;
  }
  if(!body.tickets || body.tickets.length === 0){
    target.innerHTML = "<p class='muted'>No tickets yet.</p>";
    return;
  }

  target.innerHTML = body.tickets.map(t => {
    const sel = (t.selections || []).map(s => {
      const correct = s.is_correct === true ? "✅" : s.is_correct === false ? "❌" : "";
      const res = s.result || "pending";
      return `<li>Match ${s.match_id}: ${s.selection} → result: ${res} ${correct}</li>`;
    }).join("");

    return `
      <div class="ticket">
        <div style="display:flex;justify-content:space-between;flex-wrap:wrap;">
          <div><b>Ticket #${t.id}</b> — ₦${(t.amount_kobo/100).toLocaleString()}</div>
          <div class="muted">${new Date(t.created_at).toLocaleString()}</div>
        </div>
        <div class="muted">Round ${t.round_id} · ${t.status} · Ref: ${t.reference || ''}</div>
        <ul>${sel}</ul>
      </div>
    `;
  }).join("");
}

// init
(async ()=>{
  if(!getToken()){
    alert("Please login first.");
    location.href = "index.html";
    return;
  }
  await loadRound();
  await loadTickets();
})();
</script>
</body>
</html>
