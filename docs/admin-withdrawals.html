<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Update Results | PremierPredict</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <style>
    #spinner {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      display: none;
    }
    #spinner div {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Spinner -->
  <div id="spinner"><div></div></div>

  <!-- Header -->
  <header class="flex items-center justify-between p-4 bg-white shadow">
    <div class="flex items-center text-blue-600 font-semibold">
      <i data-feather="settings" class="w-5 h-5 mr-2"></i>
      Admin Control Panel
    </div>
    <button onclick="loadRounds()" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">Reload</button>
  </header>

  <main class="max-w-3xl mx-auto p-6 mt-6 bg-white rounded-2xl shadow">
    <h1 class="text-xl font-bold text-blue-600 mb-4">Manage Jackpot Results</h1>

    <!-- Select Round -->
    <div class="mb-4">
      <label class="block text-sm font-semibold text-gray-700">Select Round</label>
      <select id="roundSelect" class="w-full border rounded-lg px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-300"></select>
    </div>

    <!-- Matches List -->
    <div id="matchesList" class="space-y-3"></div>

    <button id="saveBtn"
      class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold transition">
      ✅ Save Results
    </button>

    <p id="msg" class="mt-4 text-center text-sm text-gray-700"></p>
  </main>

  <script>
    feather.replace();

    const API_URL = "https://premierpredict.onrender.com/api";
    const spinner = document.getElementById("spinner");
    const showSpinner = () => spinner.style.display = "flex";
    const hideSpinner = () => spinner.style.display = "none";

    async function loadRounds() {
      showSpinner();
      try {
        const res = await fetch(`${API_URL}/jackpot/rounds`);
        const data = await res.json();
        hideSpinner();

        const select = document.getElementById("roundSelect");
        select.innerHTML = "";
        if (!data.rounds || !data.rounds.length) {
          select.innerHTML = `<option>No rounds found</option>`;
          document.getElementById("matchesList").innerHTML = "";
          return;
        }

        data.rounds.forEach(r => {
          const opt = document.createElement("option");
          opt.value = r.id;
          opt.textContent = `${r.name} (Round ${r.id})`;
          select.appendChild(opt);
        });

        loadMatches(data.rounds[0].id);
        select.onchange = () => loadMatches(select.value);
      } catch (err) {
        hideSpinner();
        console.error(err);
        alert("Error loading rounds");
      }
    }

    async function loadMatches(roundId) {
      showSpinner();
      try {
        const res = await fetch(`${API_URL}/jackpot/round/${roundId}`);
        const data = await res.json();
        hideSpinner();

        const container = document.getElementById("matchesList");
        if (!data.matches || !data.matches.length) {
          container.innerHTML = `<p>No matches for this round.</p>`;
          return;
        }

        container.innerHTML = data.matches.map(m => `
          <div class="p-3 border rounded-lg bg-gray-50">
            <p class="font-semibold">${m.home_team} vs ${m.away_team}</p>
            <div class="mt-2 flex space-x-2">
              <select id="res_${m.id}" class="border rounded px-2 py-1">
                <option value="">Select Result</option>
                <option value="H" ${m.result==="H"?"selected":""}>Home Win</option>
                <option value="D" ${m.result==="D"?"selected":""}>Draw</option>
                <option value="A" ${m.result==="A"?"selected":""}>Away Win</option>
              </select>
            </div>
          </div>
        `).join("");
      } catch (err) {
        hideSpinner();
        console.error(err);
        alert("Error loading matches");
      }
    }

    document.getElementById("saveBtn").onclick = async () => {
      const roundId = document.getElementById("roundSelect").value;
      const matches = [...document.querySelectorAll("[id^='res_']")].map(sel => ({
        match_id: Number(sel.id.split("_")[1]),
        result: sel.value
      }));

      if (matches.some(m => !m.result)) {
        alert("⚠ Please select results for all matches.");
        return;
      }

      showSpinner();
      try {
        const res = await fetch(`${API_URL}/jackpot/update-results`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ round_id: roundId, results: matches })
        });
        const data = await res.json();
        hideSpinner();

        if (res.ok) {
          document.getElementById("msg").textContent = "✅ Results updated successfully!";
          document.getElementById("msg").className = "mt-4 text-center text-green-600";
        } else {
          document.getElementById("msg").textContent = "❌ " + (data.error || "Error updating results");
          document.getElementById("msg").className = "mt-4 text-center text-red-600";
        }
      } catch (err) {
        hideSpinner();
        console.error(err);
        alert("Error saving results");
      }
    };

    loadRounds();
  </script>
</body>
</html>
