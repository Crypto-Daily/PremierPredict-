<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PremierPredict Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="flex flex-col min-h-screen">
    <header class="bg-blue-700 text-white p-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">PremierPredict Admin</h1>
    </header>

    <main class="p-4 space-y-6 flex-1">

      <!-- üîπ CREATE NEW ROUND -->
      <section class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-3">üèÜ Create New Jackpot Round</h2>
        <form id="newRoundForm" class="flex flex-wrap gap-2">
          <input type="text" id="roundName" placeholder="Round name" class="border p-2 rounded w-full sm:w-1/4">
          <input type="datetime-local" id="startTime" class="border p-2 rounded w-full sm:w-1/4">
          <input type="datetime-local" id="endTime" class="border p-2 rounded w-full sm:w-1/4">
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Create</button>
        </form>
        <div id="roundsList" class="mt-3 overflow-x-auto text-sm"></div>
      </section>

      <!-- üîπ WITHDRAWALS -->
      <section class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-3">üí∏ Withdrawal Requests</h2>
        <div id="withdrawalList" class="overflow-x-auto text-sm">Loading...</div>
      </section>

      <!-- üîπ TICKETS -->
      <section class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-3">üé´ User Tickets</h2>
        <div id="ticketsList" class="overflow-x-auto text-sm">Loading...</div>
      </section>

    </main>
  </div>

  <script>
    const API_BASE = "/api/withdrawals";

    // Helper Fetch function
    async function apiFetch(url, options = {}) {
      const res = await fetch(url, {
        ...options,
        headers: { "Content-Type": "application/json" },
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    /* ==========================================================
      üèÜ CREATE ROUND
    ========================================================== */
    document.getElementById("newRoundForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = roundName.value.trim();
      const start_time = startTime.value;
      const end_time = endTime.value;
      if (!name || !start_time || !end_time) return alert("All fields required");

      try {
        await apiFetch(`${API_BASE}/rounds`, {
          method: "POST",
          body: JSON.stringify({ name, start_time, end_time }),
        });
        alert("‚úÖ New round created!");
        loadRounds();
      } catch (err) {
        console.error(err);
        alert("‚ùå Error creating round");
      }
    });

    /* ==========================================================
      üí∏ LOAD WITHDRAWALS
    ========================================================== */
    async function loadWithdrawals() {
      try {
        const data = await apiFetch(`${API_BASE}/admin`);
        withdrawalList.innerHTML = `
          <table class="min-w-full text-left border">
            <thead class="bg-gray-200">
              <tr>
                <th class="p-2">User</th>
                <th class="p-2">Bank</th>
                <th class="p-2">Account</th>
                <th class="p-2">Amount</th>
                <th class="p-2">Status</th>
                <th class="p-2">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${data.length === 0 ? 
                `<tr><td colspan="6" class="p-3 text-center text-gray-500">No withdrawals yet</td></tr>` :
                data.map(w => `
                <tr class="border-t">
                  <td class="p-2">${w.username}</td>
                  <td class="p-2">${w.bank_name}</td>
                  <td class="p-2">${w.account_number}</td>
                  <td class="p-2">‚Ç¶${(w.amount_kobo / 100).toFixed(2)}</td>
                  <td class="p-2 font-medium">${w.status}</td>
                  <td class="p-2 space-x-2">
                    ${w.status === "pending" ? `
                      <button onclick="approveWithdrawal(${w.id})" class="bg-green-500 text-white px-2 py-1 rounded">Approve</button>
                      <button onclick="rejectWithdrawal(${w.id})" class="bg-red-500 text-white px-2 py-1 rounded">Reject</button>
                    ` : "‚Äî"}
                  </td>
                </tr>`).join("")}
            </tbody>
          </table>`;
      } catch (err) {
        console.error(err);
        withdrawalList.innerHTML = `<p class="text-red-500">Error loading withdrawals</p>`;
      }
    }

    async function approveWithdrawal(id) {
      if (!confirm("Mark as paid?")) return;
      try {
        await apiFetch(`${API_BASE}/${id}/approve`, { method: "POST" });
        loadWithdrawals();
      } catch (err) {
        alert("‚ùå Error approving withdrawal");
      }
    }

    async function rejectWithdrawal(id) {
      if (!confirm("Reject and refund user?")) return;
      try {
        await apiFetch(`${API_BASE}/${id}/reject`, { method: "POST" });
        loadWithdrawals();
      } catch (err) {
        alert("‚ùå Error rejecting withdrawal");
      }
    }

    /* ==========================================================
      üèÜ LOAD ROUNDS
    ========================================================== */
    async function loadRounds() {
      try {
        const res = await fetch(`/api/dashboard/rounds`);
        const data = await res.json();
        roundsList.innerHTML = `
          <table class="min-w-full text-left border">
            <thead class="bg-gray-200">
              <tr>
                <th class="p-2">Name</th>
                <th class="p-2">Status</th>
                <th class="p-2">Start</th>
                <th class="p-2">End</th>
              </tr>
            </thead>
            <tbody>
              ${data.length === 0 ? `<tr><td colspan="4" class="p-3 text-center text-gray-500">No rounds yet</td></tr>` :
                data.map(r => `
                <tr class="border-t">
                  <td class="p-2">${r.name}</td>
                  <td class="p-2">${r.status}</td>
                  <td class="p-2">${new Date(r.start_time).toLocaleString()}</td>
                  <td class="p-2">${new Date(r.end_time).toLocaleString()}</td>
                </tr>`).join("")}
            </tbody>
          </table>`;
      } catch (err) {
        console.error(err);
        roundsList.innerHTML = `<p class="text-red-500">Error loading rounds</p>`;
      }
    }

    /* ==========================================================
      üé´ LOAD TICKETS
    ========================================================== */
    async function loadTickets() {
      try {
        const data = await apiFetch(`${API_BASE}/tickets`);
        ticketsList.innerHTML = `
          <table class="min-w-full text-left border">
            <thead class="bg-gray-200">
              <tr>
                <th class="p-2">User</th>
                <th class="p-2">Round</th>
                <th class="p-2">Created</th>
                <th class="p-2">Status</th>
              </tr>
            </thead>
            <tbody>
              ${data.length === 0 ? `<tr><td colspan="4" class="p-3 text-center text-gray-500">No tickets yet</td></tr>` :
                data.map(t => `
                <tr class="border-t">
                  <td class="p-2">${t.username}</td>
                  <td class="p-2">${t.round_name}</td>
                  <td class="p-2">${new Date(t.created_at).toLocaleString()}</td>
                  <td class="p-2 font-medium">${t.ticket_status}</td>
                </tr>`).join("")}
            </tbody>
          </table>`;
      } catch (err) {
        console.error(err);
        ticketsList.innerHTML = `<p class="text-red-500">Error loading tickets</p>`;
      }
    }

    // üöÄ INIT
    loadRounds();
    loadWithdrawals();
    loadTickets();
  </script>
</body>
  </html>
