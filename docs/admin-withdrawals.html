<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard | PremierPredict</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div class="flex flex-col min-h-screen">
    <header class="bg-blue-700 text-white p-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">PremierPredict Admin</h1>
      <button id="logoutBtn" class="bg-red-500 px-3 py-1 rounded">Logout</button>
    </header>

    <main class="p-4 flex-1 space-y-6">
      <!-- ROUNDS MANAGEMENT -->
      <section class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-3">üèÜ Manage Jackpot Rounds</h2>
        <form id="newRoundForm" class="flex gap-2 flex-wrap mb-3">
          <input type="text" id="roundName" placeholder="Round name" class="border p-2 rounded w-full sm:w-1/4">
          <input type="datetime-local" id="startTime" class="border p-2 rounded w-full sm:w-1/4">
          <input type="datetime-local" id="endTime" class="border p-2 rounded w-full sm:w-1/4">
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Create Round</button>
        </form>
        <div id="roundsList" class="overflow-x-auto"></div>
      </section>

      <!-- WITHDRAWALS -->
      <section class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-3">üí∏ Withdrawal Requests</h2>
        <div id="withdrawalList" class="overflow-x-auto"></div>
      </section>

      <!-- USERS -->
      <section class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-3">üë§ Users & Wallets</h2>
        <div id="usersList" class="overflow-x-auto"></div>
      </section>

      <!-- TICKETS -->
      <section class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-3">üé´ Tickets per Round</h2>
        <div id="ticketsList" class="overflow-x-auto"></div>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = "/api"; // Adjust if hosted differently
    const token = localStorage.getItem("token");

    // --- Redirect if not logged in ---
    if (!token) {
      alert("You must be logged in as admin");
      window.location.href = "/login.html";
    }

    // --- Helper for Fetch with Auth ---
    async function apiFetch(url, options = {}) {
      const res = await fetch(url, {
        ...options,
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
          ...(options.headers || {}),
        },
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    /* ==========================================================
      üèÜ CREATE ROUND
    ========================================================== */
    document.getElementById("newRoundForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = roundName.value;
      const start_time = startTime.value;
      const end_time = endTime.value;
      try {
        await apiFetch(`${API_BASE}/withdrawals/rounds`, {
          method: "POST",
          body: JSON.stringify({ name, start_time, end_time }),
        });
        alert("New round created");
        loadRounds();
      } catch (err) {
        alert("Error creating round");
        console.error(err);
      }
    });

    /* ==========================================================
      üí∏ LOAD WITHDRAWALS
    ========================================================== */
    async function loadWithdrawals() {
      try {
        const data = await apiFetch(`${API_BASE}/withdrawals/admin`);
        withdrawalList.innerHTML = `
          <table class="min-w-full text-sm text-left">
            <thead>
              <tr class="bg-gray-200">
                <th class="p-2">User</th>
                <th class="p-2">Bank</th>
                <th class="p-2">Amount</th>
                <th class="p-2">Status</th>
                <th class="p-2">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${data.map(w => `
                <tr class="border-b">
                  <td class="p-2">${w.username}</td>
                  <td class="p-2">${w.bank_name}</td>
                  <td class="p-2">‚Ç¶${(w.amount_kobo/100).toFixed(2)}</td>
                  <td class="p-2">${w.status}</td>
                  <td class="p-2">
                    ${w.status === "pending" ? `
                      <button class="bg-green-500 text-white px-2 py-1 rounded" onclick="approveWithdrawal(${w.id})">Approve</button>
                      <button class="bg-red-500 text-white px-2 py-1 rounded" onclick="rejectWithdrawal(${w.id})">Reject</button>
                    ` : "‚Äî"}
                  </td>
                </tr>`).join("")}
            </tbody>
          </table>`;
      } catch (err) {
        console.error(err);
        withdrawalList.innerHTML = "Error loading withdrawals";
      }
    }

    async function approveWithdrawal(id) {
      if (confirm("Mark as paid?")) {
        await apiFetch(`${API_BASE}/withdrawals/${id}/approve`, { method: "POST" });
        loadWithdrawals();
      }
    }

    async function rejectWithdrawal(id) {
      if (confirm("Reject and refund?")) {
        await apiFetch(`${API_BASE}/withdrawals/${id}/reject`, { method: "POST" });
        loadWithdrawals();
      }
    }

    /* ==========================================================
      üèÜ LOAD ROUNDS
    ========================================================== */
    async function loadRounds() {
      try {
        const data = await apiFetch(`${API_BASE}/dashboard/rounds`);
        roundsList.innerHTML = `
          <table class="min-w-full text-sm text-left">
            <thead><tr class="bg-gray-200">
              <th class="p-2">Name</th><th class="p-2">Status</th><th class="p-2">Start</th><th class="p-2">End</th>
            </tr></thead>
            <tbody>
              ${data.map(r => `
                <tr class="border-b">
                  <td class="p-2">${r.name}</td>
                  <td class="p-2">${r.status}</td>
                  <td class="p-2">${new Date(r.start_time).toLocaleString()}</td>
                  <td class="p-2">${new Date(r.end_time).toLocaleString()}</td>
                </tr>`).join("")}
            </tbody>
          </table>`;
      } catch (err) {
        console.error(err);
        roundsList.innerHTML = "Error loading rounds";
      }
    }

    /* ==========================================================
      üë§ LOAD USERS
    ========================================================== */
    async function loadUsers() {
      try {
        const data = await apiFetch(`${API_BASE}/dashboard/users`);
        usersList.innerHTML = `
          <table class="min-w-full text-sm text-left">
            <thead><tr class="bg-gray-200">
              <th class="p-2">Username</th><th class="p-2">Email</th><th class="p-2">Balance</th><th class="p-2">Action</th>
            </tr></thead>
            <tbody>
              ${data.map(u => `
                <tr class="border-b">
                  <td class="p-2">${u.username}</td>
                  <td class="p-2">${u.email}</td>
                  <td class="p-2">‚Ç¶${(u.balance_kobo / 100).toFixed(2)}</td>
                  <td class="p-2">
                    <button class="bg-yellow-500 text-white px-2 py-1 rounded" onclick="updateBalance(${u.id})">Update</button>
                  </td>
                </tr>`).join("")}
            </tbody>
          </table>`;
      } catch (err) {
        console.error(err);
        usersList.innerHTML = "Error loading users";
      }
    }

    async function updateBalance(userId) {
      const amount = prompt("Enter new balance (‚Ç¶):");
      if (!amount) return;
      try {
        await apiFetch(`${API_BASE}/dashboard/users/${userId}/balance`, {
          method: "PUT",
          body: JSON.stringify({ amount }),
        });
        alert("Balance updated");
        loadUsers();
      } catch (err) {
        alert("Error updating balance");
      }
    }

    /* ==========================================================
      üé´ LOAD TICKETS
    ========================================================== */
    async function loadTickets() {
      try {
        const data = await apiFetch(`${API_BASE}/withdrawals/tickets`);
        ticketsList.innerHTML = `
          <table class="min-w-full text-sm text-left">
            <thead><tr class="bg-gray-200">
              <th class="p-2">User</th><th class="p-2">Round</th><th class="p-2">Created</th><th class="p-2">Status</th>
            </tr></thead>
            <tbody>
              ${data.map(t => `
                <tr class="border-b">
                  <td class="p-2">${t.username}</td>
                  <td class="p-2">${t.round_name}</td>
                  <td class="p-2">${new Date(t.created_at).toLocaleString()}</td>
                  <td class="p-2">${t.ticket_status}</td>
                </tr>`).join("")}
            </tbody>
          </table>`;
      } catch (err) {
        console.error(err);
        ticketsList.innerHTML = "Error loading tickets";
      }
    }

    /* ==========================================================
      üöÄ INIT
    ========================================================== */
    loadRounds();
    loadWithdrawals();
    loadUsers();
    loadTickets();

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("token");
      window.location.href = "/login.html";
    });
  </script>
</body>
  </html>
